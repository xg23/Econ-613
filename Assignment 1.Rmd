---
title: "Assignment 1"
author: "Xiaoshu Gui"
date: "1/24/2019"
output: pdf_document
---

```{r message=FALSE, warning=FALSE}
# Load packages
library(dplyr)
library(purrr)
library(magrittr)
library(tidyr)
library(tibble)
library(stringr)
library(reshape2)

# Read data
jss <- read.csv("datjss.csv", header=T, sep=",")
sss <- read.csv("datsss.csv", header=T, sep=",")
stu <- read.csv("datstu.csv", header=T, sep=",", na.strings=c(""," ","NA"))
# Note that there are empty cells in stu, we replace them with NAs first.
```

## Exercise 1
* Number of students: 340823
```{r}
length(unique(stu$X))
```

* Number of schools: 898
```{r}
length(unique(sss$schoolcode))
```

* Number of programs: 32
```{r}
pgm <- stu %>% 
  select(starts_with("choice")) %>% # get a subset of stu (choicepgm1 ~ 6)
  map(., function(x) unique(x)) %>% # find the number of programs in each "choicepgm"
  unlist %>% 
  unique() %>%  # join all the unique programs in 6 choices and find the unique value.
  length() 
# Note that there's NA in choicepgm, so the number of programs is: 33 - 1 = 32
```

* Number of choices (school, program): 
```{r message=FALSE, warning=FALSE}
school <- stu %>%
  select(X:schoolcode6) %>%
  gather(key = 'school', 'schoolcode', -c(X:male)) %>%
  mutate(choice = str_match(school, "[1-6]") %>% as.numeric())

pgm <- stu %>% 
  select(X, choicepgm1:rankplace) %>%
  gather(key = 'program', 'choicepgm', -c(X, jssdistrict, rankplace))   %>%
    mutate(choice = str_match(program, "[1-6]") %>% as.numeric())

stu1 <- left_join(school, pgm, by = c("X", "choice")) %>%
   drop_na(., c(schoolcode,choicepgm)) %>%
   mutate(choice_sp = paste(schoolcode, choicepgm, sep = ","))

# number of all choices of school and program:
length(stu1$choice_sp)

# number of unique choices of school and program
length(unique(stu1$choice_sp))
```

* Missing test score: 179887 (number of NAs in "score" in datstu)

* Apply to the same school (different programs)
```{r}
stu2 <- stu1 %>%
  group_by(schoolcode) %>%
  summarise(count= n())

# The table presents the number of students apply to the same school (dif programs)
stu2
```

* Apply to less than 6 choices: 20988

```{r}
# rule out NAs in choicepgm, leaving us students who apply 6 choices
stu3 <- drop_na(stu, starts_with("choice"))

# then students who apply less than 6 choices should be total number of students minus those who apply 6 choices:
340823 - count(stu3)

# na.omit(stu[11:16])
```


## Excercise 2
```{r}
df <- stu1 %>%
  select(X, choice_sp, schoolcode, score)

ss <- sss %>% 
  select(-X) %>%
  mutate(schoolname = str_remove_all(ss$schoolname, "\\d")) %>% # remove all school names start with schoolcode
  mutate(schoolname = str_remove_all(ss$schoolname, "\\W")) %>%
  distinct() 

ss %>% drop_na()


  str_detect(ss$schoolname[3075:3090],"\\W")
  





stu4 <- left_join(df, ss, by = "schoolcode")

# drop students that are not get enrolled in any school-pgm.
stu4 <- stu %>% 
  filter(!is.na(rankplace)) %>% # drop NAs in rankplace
  filter(rankplace < 7) #%>%   # drop 99s in rankplace

#map(t1, function(x) paste(t1[x, 4 + t1$rankplace[[i]]], t1[x, 10 + t1$rankplace[[i]]]))

```



## Excercise 3 Distance
```{r}
distance <- stu %>%
  select(X, schoolcode1:schoolcode6, jssdistrict)
```

